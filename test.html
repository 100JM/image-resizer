<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resizer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
        }

        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <h1>Image Resizer 라이브러리 테스트</h1>

    <div class="test-section">
        <h2>파일 업로드 테스트</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="testResizer()">리사이징 테스트</button>
        <div id="result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>기능 테스트</h2>
        <button onclick="testBasicFunction()">기본 기능 테스트</button>
        <button onclick="testDifferentSizes()">다양한 크기 테스트</button>
        <div id="functionResult" class="result" style="display: grid;"></div>
    </div>

    <script type="module">
        // 빌드된 라이브러리 import (빌드 후 사용)
        // import { resizer } from './dist/index.js';

        // 임시로 직접 함수 정의 (빌드 전 테스트용)
        const resizer = (file, maxWidth, maxHeight, quality = 0.7, format = 'jpeg', imageSmoothingEnabled = true, imageSmoothingQuality = 'high') => {
            return new Promise((resolve, reject) => {

                const isFile = file instanceof File;
                const isBuffer = false;

                if (!isFile && !isBuffer) {
                    reject(new Error('File or Buffer is required'));
                    return;
                }

                const processImage = async (dataUrl) => {

                    const img = new Image();

                    img.onload = () => {
                        try {
                            let width = img.width;
                            let height = img.height;
                            let originalWidth = img.width;
                            let originalHeight = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            }

                            width = Math.max(Math.round(width), 1);
                            height = Math.max(Math.round(height), 1);

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');

                            if (!ctx) {
                                throw new Error('Failed to get canvas context');
                            }

                            ctx.imageSmoothingEnabled = imageSmoothingEnabled ?? true;
                            ctx.imageSmoothingQuality = imageSmoothingQuality ?? 'high';

                            ctx.drawImage(img, 0, 0, width, height);

                            canvas.toBlob((blob) => {
                                resolve({
                                    blob,
                                    width,
                                    height,
                                    originalWidth,
                                    originalHeight,
                                });
                            }, `image/${format}`, quality);


                        } catch (error) {
                            reject(error);
                        }
                    };

                    img.onerror = () => reject(new Error('Image loading failed'));
                    img.src = dataUrl;
                };

                if (isFile) {
                    const imgReader = new FileReader();

                    imgReader.onload = (event) => {
                        const dataUrl = event.target?.result;
                        processImage(dataUrl);
                    };

                    imgReader.onerror = () => reject(new Error('File reading failed'));
                    imgReader.readAsDataURL(file);

                } else {
                    const dataUrl = `data:image/jpeg;base64,${file.toString('base64')}`;
                    processImage(dataUrl);
                }
            });
        };

        // 전역 함수로 등록
        window.resizer = resizer;

        window.testResizer = async function () {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('result');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span class="error">파일을 선택해주세요.</span>';
                return;
            }

            const file = fileInput.files[0];
            resultDiv.innerHTML = '<span>처리 중...</span>';

            try {
                const result = await resizer(file, 300, 200, 0.8, 'jpeg', true);

                resultDiv.innerHTML = `
                    <span class="success">성공!</span><br>
                    원본: ${result.originalWidth} x ${result.originalHeight}<br>
                    리사이즈: ${result.width} x ${result.height}<br>
                    파일 크기: ${(result.blob.size / 1024).toFixed(2)} KB
                `;

                // 미리보기 생성
                const preview = document.createElement('img');
                const url = URL.createObjectURL(result.blob);
                preview.src = url;
                preview.style.maxWidth = '200px';
                preview.style.marginTop = '10px';

                preview.onload = () => {
                    URL.revokeObjectURL(url);
                }

                resultDiv.appendChild(preview);

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">에러: ${error.message}</span>`;
            }
        };

        window.testBasicFunction = async function () {
            const resultDiv = document.getElementById('functionResult');
            resultDiv.innerHTML = '<span>기본 기능 테스트 중...</span>';

            try {
                // 간단한 테스트 이미지 생성
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 100, 100);

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'test.png', { type: 'image/png' });

                    const result = await resizer(file, 50, 50);

                    resultDiv.innerHTML = `
                        <span class="success">기본 기능 테스트 성공!</span><br>
                        결과: ${result.width} x ${result.height}
                    `;

                    const preview = document.createElement('img');
                    const url = URL.createObjectURL(result.blob);
                    preview.src = url;
                    preview.style.maxWidth = '200px';
                    preview.style.marginTop = '10px';

                    preview.onload = () => {
                        URL.revokeObjectURL(url);
                    };

                    resultDiv.appendChild(preview);
                });

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">기본 기능 테스트 실패: ${error.message}</span>`;
            }
        };

        window.testDifferentSizes = async function () {
            const resultDiv = document.getElementById('functionResult');
            resultDiv.innerHTML = '<span>다양한 크기 테스트 중...</span>';

            try {
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'blue';
                ctx.fillRect(0, 0, 800, 600);

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'test.png', { type: 'image/png' });

                    const results = [];
                    const blobResults = [];
                    // 다양한 크기로 테스트
                    const sizes = [
                        { width: 400, height: 300 },
                        { width: 200, height: 150 },
                        { width: 100, height: 75 }
                    ];

                    for (const size of sizes) {
                        const result = await resizer(file, Math.floor((size.width / 2)), Math.floor(size.height / 2));
                        results.push(`${size.width}x${size.height} → ${result.width}x${result.height}`);
                        blobResults.push(result.blob);
                    }

                    resultDiv.innerHTML = `
                        <span class="success">다양한 크기 테스트 성공!</span><br>
                        ${results.join('<br>')}
                    `;

                    for (const r of blobResults) {
                        let preview = document.createElement('img');
                        const url = URL.createObjectURL(r);
                        preview.src = url;
                        preview.style.maxWidth = '200px';
                        preview.style.marginTop = '10px';

                        preview.onload = () => {
                            URL.revokeObjectURL(url);
                        };

                        resultDiv.appendChild(preview);
                    }
                });

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">다양한 크기 테스트 실패: ${error.message}</span>`;
            }
        };
    </script>
</body>

</html>